#!/bin/bash

#=============================================================================
# tmux-tools - Unified command interface for tmux tools
#=============================================================================
#
# PURPOSE:
#   Single entry point for all tmux-tools operations, providing a consistent
#   interface and command-line experience.
#
# FUNCTIONALITY:
#   - tmux-tools status              # Current tmux-status.sh
#   - tmux-tools overview           # Current tmux-overview
#   - tmux-tools rename --auto      # Smart renaming
#   - tmux-tools config             # Configuration management
#   - tmux-tools help              # Help and documentation
#
# USAGE EXAMPLES:
#   tmux-tools status                    # Show compact status
#   tmux-tools status --show-pid         # Show detailed status
#   tmux-tools overview --detailed       # Show detailed overview
#   tmux-tools overview --json           # JSON output
#   tmux-tools rename sessions          # Rename all sessions
#   tmux-tools rename windows           # Rename all windows
#   tmux-tools rename --auto             # Smart auto-rename
#   tmux-tools config show              # Show current configuration
#   tmux-tools config create             # Create example config file
#   tmux-tools help                      # Show help
#
#=============================================================================

# Get the directory where this script is located (resolving symlinks)
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$SCRIPT_DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"

# Source shared libraries
source "$SCRIPT_DIR/lib/tmux_core.sh"
source "$SCRIPT_DIR/lib/tmux_display.sh"
source "$SCRIPT_DIR/lib/tmux_colors.sh"
source "$SCRIPT_DIR/lib/tmux_config.sh"

# Version information
VERSION="1.1.1"

# Show main help
show_main_help() {
  cat << EOF
tmux-tools - Unified interface for tmux session management tools

USAGE:
    tmux-tools <command> [options]
    tt <command> [options]              # Short alias

COMMANDS:
    status, s, stat     Show tmux session status in tabular format (default)
    overview, o, ov     Show comprehensive session overview
    rename, r, ren      Rename sessions and windows
    config, c, conf     Manage configuration settings
    help, h             Show tmux command reference and help
    version, v, ver     Show version information

EXAMPLES:
    tmux-tools status                    # Show compact status
    tt s --show-pid                      # Show detailed status (short form)
    tt stat                              # Show status (alternate short form)
    tt o --detailed                      # Show detailed overview (short form)
    tt ov --json                         # Output overview in JSON (short form)
    tt r sessions                        # Rename all sessions (short form)
    tt ren auto                          # Smart auto-rename (short form)
    tt c                                 # Show current configuration (short form)
    tt conf create                       # Create config file (short form)
    tt h                                 # Show tmux command reference
    tt h ses                             # Show session commands
    tt h win                             # Show window commands
    tt v                                 # Show version (short form)

Use 'tmux-tools <command> --help' for more information on a specific command.
Use 'tt h <topic>' for tmux command reference (ses, win, pan, layouts, copy, misc)
EOF
}

# Show version information
show_version() {
  echo "tmux-tools version $VERSION"
}

# Status command (delegates to tmux-status.sh)
cmd_status() {
  exec "$SCRIPT_DIR/tmux-status.sh" "$@"
}

# Overview command (delegates to tmux-overview)
cmd_overview() {
  exec "$SCRIPT_DIR/tmux-overview" "$@"
}

# Rename command
cmd_rename() {
  local subcommand="$1"
  shift

  case "$subcommand" in
    sessions)
      exec "$SCRIPT_DIR/tmux-status.sh" --rename-sessions "$@"
      ;;
    windows)
      exec "$SCRIPT_DIR/tmux-status.sh" --rename-windows "$@"
      ;;
    --auto|auto)
      exec "$SCRIPT_DIR/tmux-status.sh" --rename-auto "$@"
      ;;
    --help|-h|help)
      cat << EOF
tmux-tools rename - Rename sessions and windows

USAGE:
    tmux-tools rename [subcommand] [options]

SUBCOMMANDS:
    sessions        Rename ALL sessions to city names
    windows         Rename ALL windows to directory names
    auto, --auto    Smart rename: cities for sessions, directories for windows

EXAMPLES:
    tmux-tools rename               # Show this help
    tmux-tools rename sessions      # Rename all sessions to cities
    tmux-tools rename windows       # Rename all windows to directory names
    tmux-tools rename auto          # Smart rename (cities + directories)

The rename command uses directory names from the active pane's current
working directory for windows, and city names configured in your
tmux-tools configuration file (~/.tmux-tools.yaml) for sessions.
EOF
      ;;
    "")
      # Show help when no subcommand provided
      cmd_rename --help
      ;;
    *)
      echo "Error: Unknown rename subcommand '$subcommand'" >&2
      echo "Use 'tmux-tools rename --help' for usage information" >&2
      exit 1
      ;;
  esac
}

# Config command
cmd_config() {
  local subcommand="$1"
  shift

  case "$subcommand" in
    show)
      # Load and display current configuration
      load_config

      echo "tmux-tools Configuration"
      echo "========================"
      echo
      echo "Configuration file: $(find_config_file || echo "Not found")"
      echo
      echo "Current settings:"
      echo "  Theme: $(get_config_value "theme")"
      echo "  Pager: $(get_config_value "pager")"
      echo "  Session pool: $(get_config_value "session_pool")"
      echo "  Attachment indicator: $(get_config_value "attachment_indicator")"
      echo "  Default format: $(get_config_value "default_format")"
      echo "  Show timestamps: $(get_config_value "show_timestamps")"
      echo "  Group sessions: $(get_config_value "group_sessions")"
      echo
      echo "Available session names:"
      get_session_names | sed 's/^/  /'
      ;;
    create)
      local config_file="$HOME/.tmux-tools.yaml"
      if [[ -f "$config_file" ]]; then
        echo "Configuration file already exists at $config_file"
        echo "Remove it first if you want to create a new one."
        exit 1
      fi

      create_example_config "$config_file"
      echo "Example configuration file created at $config_file"
      echo "Edit this file to customize your tmux-tools settings."
      ;;
    edit)
      local config_file
      config_file=$(find_config_file)
      if [[ -z "$config_file" ]]; then
        echo "No configuration file found. Use 'tmux-tools config create' first."
        exit 1
      fi

      local editor="${EDITOR:-vim}"
      exec "$editor" "$config_file"
      ;;
    --help|-h|help)
      cat << EOF
tmux-tools config - Manage configuration settings

USAGE:
    tmux-tools config [subcommand]

SUBCOMMANDS:
    show            Show current configuration settings (default)
    create          Create an example configuration file
    edit            Edit the configuration file

EXAMPLES:
    tmux-tools config               # Show current settings (default)
    tmux-tools config show          # Show current settings
    tmux-tools config create        # Create ~/.tmux-tools.yaml
    tmux-tools config edit          # Edit configuration file

Configuration files are searched in this order:
  ~/.tmux-tools.yaml
  ~/.tmux-tools.yml
  ~/.config/tmux-tools/config.yaml
  ~/.config/tmux-tools/config.yml
  ./tmux-tools.yaml
  ./tmux-tools.yml
EOF
      ;;
    "")
      # Default to show when no subcommand provided
      cmd_config show
      ;;
    *)
      echo "Error: Unknown config subcommand '$subcommand'" >&2
      echo "Use 'tmux-tools config --help' for usage information" >&2
      exit 1
      ;;
  esac
}

# Determine the best pager to use
# Returns the pager command to use
get_pager() {
  local configured_pager
  configured_pager=$(get_config_value "pager" "auto")

  case "$configured_pager" in
    auto)
      # Auto-detect best available pager
      if command -v glow &> /dev/null; then
        echo "glow -p"
      elif command -v bat &> /dev/null; then
        echo "bat --style=plain --paging=always"
      else
        echo "less -R"
      fi
      ;;
    glow)
      if command -v glow &> /dev/null; then
        echo "glow -p"
      else
        echo "less -R"
      fi
      ;;
    bat)
      if command -v bat &> /dev/null; then
        echo "bat --style=plain --paging=always"
      else
        echo "less -R"
      fi
      ;;
    less)
      echo "less -R"
      ;;
    cat)
      echo "cat"
      ;;
    *)
      # Try using the configured pager if it exists
      if command -v "$configured_pager" &> /dev/null; then
        echo "$configured_pager"
      else
        echo "less -R"
      fi
      ;;
  esac
}

# Check if pager needs colorization
# Returns 0 (true) if we should use colorize_markdown
pager_needs_colorization() {
  local pager="$1"
  # Only use colorize_markdown for less or cat
  if [[ "$pager" == less* ]] || [[ "$pager" == "cat" ]]; then
    return 0  # true
  else
    return 1  # false (glow, bat, etc. handle their own formatting)
  fi
}

# Help command
cmd_help() {
  local topic="$1"

  # Initialize colors for markdown formatting
  load_config
  local theme
  theme=$(get_config_value "theme")
  init_colors "$theme"

  # Determine which pager to use
  local pager_cmd
  pager_cmd=$(get_pager)

  # Check if we should use colors before piping
  local color_arg=""
  if colors_supported; then
    color_arg="force"
  fi

  case "$topic" in
    status)
      exec "$SCRIPT_DIR/tmux-status.sh" --help
      ;;
    overview)
      exec "$SCRIPT_DIR/tmux-overview" --help
      ;;
    rename)
      cmd_rename --help
      ;;
    config)
      cmd_config --help
      ;;
    commands)
      # Show full COMMANDS.md reference
      if [[ -f "$SCRIPT_DIR/docs/COMMANDS.md" ]]; then
        if pager_needs_colorization "$pager_cmd"; then
          cat "$SCRIPT_DIR/docs/COMMANDS.md" | colorize_markdown "$color_arg" | $pager_cmd
        else
          cat "$SCRIPT_DIR/docs/COMMANDS.md" | $pager_cmd
        fi
      else
        echo "Error: COMMANDS.md not found" >&2
        exit 1
      fi
      ;;
    sessions|ses|windows|win|panes|pan|layouts|copy|misc)
      # Show specific section from COMMANDS.md
      if [[ -f "$SCRIPT_DIR/docs/COMMANDS.md" ]]; then
        # Map topic to section name (bash 3.x compatible)
        local section_name
        case "$topic" in
          sessions|ses) section_name="Sessions" ;;
          windows|win) section_name="Windows" ;;
          panes|pan) section_name="Panes" ;;
          layouts) section_name="Layouts" ;;
          copy) section_name="Copy Mode" ;;
          misc) section_name="Miscellaneous" ;;
        esac

        # Extract the section using awk and display
        if pager_needs_colorization "$pager_cmd"; then
          awk -v section="$section_name" '
            /^## / {
              if (found) exit
              if ($0 ~ "## " section) found=1
            }
            found { print }
          ' "$SCRIPT_DIR/docs/COMMANDS.md" | colorize_markdown "$color_arg" | $pager_cmd
        else
          awk -v section="$section_name" '
            /^## / {
              if (found) exit
              if ($0 ~ "## " section) found=1
            }
            found { print }
          ' "$SCRIPT_DIR/docs/COMMANDS.md" | $pager_cmd
        fi
      else
        echo "Error: COMMANDS.md not found" >&2
        exit 1
      fi
      ;;
    "")
      # Show COMMANDS.md by default when no topic specified
      if [[ -f "$SCRIPT_DIR/docs/COMMANDS.md" ]]; then
        if pager_needs_colorization "$pager_cmd"; then
          cat "$SCRIPT_DIR/docs/COMMANDS.md" | colorize_markdown "$color_arg" | $pager_cmd
        else
          cat "$SCRIPT_DIR/docs/COMMANDS.md" | $pager_cmd
        fi
      else
        echo "Error: COMMANDS.md not found" >&2
        show_main_help
      fi
      ;;
    *)
      echo "Error: Unknown help topic '$topic'" >&2
      echo "Available topics: commands, sessions (ses), windows (win), panes (pan), layouts, copy, misc" >&2
      echo "Or use: status, overview, rename, config for command-specific help" >&2
      exit 1
      ;;
  esac
}

# Main command dispatcher
main() {
  # Default to status command if no arguments provided
  if [[ $# -eq 0 ]]; then
    cmd_status
    exit 0
  fi

  local command="$1"
  shift

  case "$command" in
    status|s|stat)
      cmd_status "$@"
      ;;
    overview|o|ov)
      cmd_overview "$@"
      ;;
    rename|r|ren)
      cmd_rename "$@"
      ;;
    config|c|conf)
      cmd_config "$@"
      ;;
    help|h)
      cmd_help "$@"
      ;;
    --help|-h)
      show_main_help
      ;;
    version|v|ver|--version|-v)
      show_version
      ;;
    *)
      echo "Error: Unknown command '$command'" >&2
      echo "Use 'tmux-tools help' for usage information" >&2
      exit 1
      ;;
  esac
}

main "$@"