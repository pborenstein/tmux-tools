#!/bin/bash

# tmux-overview - Display comprehensive information about all tmux sessions
# Usage: tmux-overview [options]

set -euo pipefail

# Colors for output
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[0;33m'
readonly BLUE='\033[0;34m'
readonly PURPLE='\033[0;35m'
readonly CYAN='\033[0;36m'
readonly WHITE='\033[1;37m'
readonly GRAY='\033[0;90m'
readonly BG_SUBTLE='\033[48;5;237m'
readonly NC='\033[0m' # No Color

# Default options
DETAILED=false
JSON_OUTPUT=false
SESSION_FILTER=""
SHOW_HELP=false

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    -d|--detailed)
      DETAILED=true
      shift
      ;;
    -j|--json)
      JSON_OUTPUT=true
      shift
      ;;
    -s|--session)
      SESSION_FILTER="$2"
      shift 2
      ;;
    -h|--help)
      SHOW_HELP=true
      shift
      ;;
    *)
      echo "Unknown option: $1"
      exit 1
      ;;
  esac
done

# Help function
show_help() {
  cat << EOF
tmux-overview - Display comprehensive information about all tmux sessions

USAGE:
    tmux-overview [OPTIONS]

OPTIONS:
    -d, --detailed          Show detailed view with all panes and commands
    -j, --json             Output in JSON format
    -s, --session NAME     Show only the specified session
    -h, --help             Show this help message

EXAMPLES:
    tmux-overview                    # Show summary of all sessions
    tmux-overview -d                 # Show detailed view with all panes
    tmux-overview -s milan           # Show only 'milan' session
    tmux-overview -j                 # Output in JSON format

EOF
}

# Check if tmux is running
check_tmux() {
  if ! command -v tmux >/dev/null 2>&1; then
    echo -e "${RED}Error: tmux is not installed${NC}" >&2
    exit 1
  fi

  if ! tmux list-sessions >/dev/null 2>&1; then
    echo -e "${YELLOW}No tmux sessions are currently running${NC}"
    exit 0
  fi
}

# Get session data
get_sessions() {
  local sessions_data
  sessions_data=$(tmux list-sessions -F "#{session_name}|#{session_created}|#{session_attached}|#{session_windows}" 2>/dev/null || true)

  if [[ -n "$SESSION_FILTER" ]]; then
    echo "$sessions_data" | grep "^$SESSION_FILTER|" || true
  else
    echo "$sessions_data"
  fi
}

# Get window data
get_windows() {
  local windows_data
  if [[ -n "$SESSION_FILTER" ]]; then
    windows_data=$(tmux list-windows -t "$SESSION_FILTER" -F "#{session_name}|#{window_index}|#{window_name}|#{window_panes}|#{window_active}" 2>/dev/null || true)
  else
    windows_data=$(tmux list-windows -a -F "#{session_name}|#{window_index}|#{window_name}|#{window_panes}|#{window_active}" 2>/dev/null || true)
  fi

  if [[ -n "$SESSION_FILTER" ]]; then
    echo "$windows_data" | grep "^$SESSION_FILTER|" || true
  else
    echo "$windows_data"
  fi
}

# Get pane data
get_panes() {
  local panes_data
  panes_data=$(tmux list-panes -a -F "#{session_name}|#{window_index}|#{pane_index}|#{pane_current_command}|#{pane_current_path}|#{pane_active}" 2>/dev/null || true)

  if [[ -n "$SESSION_FILTER" ]]; then
    echo "$panes_data" | grep "^$SESSION_FILTER|" || true
  else
    echo "$panes_data"
  fi
}

# Format timestamp
format_time() {
  local timestamp=$1
  if command -v gdate >/dev/null 2>&1; then
    gdate -d "@$timestamp" "+%Y-%m-%d %H:%M:%S"
  else
    date -r "$timestamp" "+%Y-%m-%d %H:%M:%S" 2>/dev/null || echo "Unknown"
  fi
}

# Format elapsed time compactly
format_elapsed() {
  local timestamp=$1
  local now=$(date +%s)
  local elapsed=$((now - timestamp))

  if [[ $elapsed -lt 60 ]]; then
    echo "${elapsed}s"
  elif [[ $elapsed -lt 3600 ]]; then
    echo "$((elapsed / 60))m"
  elif [[ $elapsed -lt 86400 ]]; then
    echo "$((elapsed / 3600))h"
  else
    echo "$((elapsed / 86400))d"
  fi
}

# JSON output
output_json() {
  local sessions_data windows_data panes_data
  sessions_data=$(get_sessions)
  windows_data=$(get_windows)
  panes_data=$(get_panes)

  echo "{"
  echo '  "sessions": ['

  local first_session=true
  while IFS='|' read -r session_name session_created session_attached session_windows; do
    [[ -z "$session_name" ]] && continue

    if [[ "$first_session" = false ]]; then
      echo ","
    fi
    first_session=false

    echo "    {"
    echo "      \"name\": \"$session_name\","
    echo "      \"created\": \"$(format_time "$session_created")\","
    echo "      \"attached\": $session_attached,"
    echo "      \"windows\": ["

    local first_window=true
    while IFS='|' read -r win_session win_index win_name win_panes win_active; do
      [[ "$win_session" != "$session_name" ]] && continue

      if [[ "$first_window" = false ]]; then
        echo ","
      fi
      first_window=false

      echo "        {"
      echo "          \"index\": $win_index,"
      echo "          \"name\": \"$win_name\","
      echo "          \"panes\": $win_panes,"
      echo "          \"active\": $win_active,"
      echo "          \"pane_details\": ["

      local first_pane=true
      while IFS='|' read -r pane_session pane_window pane_index pane_command pane_path pane_active; do
        [[ "$pane_session" != "$session_name" ]] && continue
        [[ "$pane_window" != "$win_index" ]] && continue

        if [[ "$first_pane" = false ]]; then
          echo ","
        fi
        first_pane=false

        echo "            {"
        echo "              \"index\": $pane_index,"
        echo "              \"command\": \"$pane_command\","
        echo "              \"path\": \"$pane_path\","
        echo "              \"active\": $pane_active"
        echo -n "            }"
      done <<< "$panes_data"

      echo ""
      echo "          ]"
      echo -n "        }"
    done <<< "$windows_data"

    echo ""
    echo "      ]"
    echo -n "    }"
  done <<< "$sessions_data"

  echo ""
  echo "  ]"
  echo "}"
}

# Summary output
output_summary() {
  local sessions_data windows_data
  sessions_data=$(get_sessions)
  windows_data=$(get_windows)


  local total_sessions=0
  local total_windows=0
  local session_count=0

  while IFS='|' read -r session_name session_created session_attached session_windows; do
    [[ -z "$session_name" ]] && continue

    ((total_sessions++))
    ((session_count++))
    ((total_windows += session_windows))

    local status_indicator="○"
    if [[ "$session_attached" == "1" ]]; then
      status_indicator="●"
    elif [[ "$session_attached" -gt "1" ]]; then
      status_indicator="$session_attached"
    fi

    # Determine background color (alternate sessions)
    local bg_color=""
    if [[ $((session_count % 2)) -eq 1 ]]; then
      bg_color="$BG_SUBTLE"
    fi

    # Show windows for this session
    local first_window=true

    while IFS='|' read -r win_session win_index win_name win_panes win_active; do
      [[ "$win_session" != "$session_name" ]] && continue

      local window_indicator=" "
      if [[ "$win_active" == "1" ]]; then
        window_indicator="•"
      fi

      local pane_display=""
      if [[ "$win_panes" -gt 1 ]]; then
        pane_display=" $win_panes"
      fi

      if [[ "$first_window" = true ]]; then
        first_window=false
        echo -e "${bg_color}${status_indicator} $(printf "%-11s" "$session_name") ${window_indicator} $(printf "%-11s" "$win_name")$(printf "%-2s" "$pane_display")${NC}"
      else
        echo -e "${bg_color}$(printf "%-13s" "") ${window_indicator} $(printf "%-11s" "$win_name")$(printf "%-2s" "$pane_display")${NC}"
      fi
    done <<< "$windows_data"
  done <<< "$sessions_data"

}

# Detailed output
output_detailed() {
  local sessions_data windows_data panes_data
  sessions_data=$(get_sessions)
  windows_data=$(get_windows)
  panes_data=$(get_panes)

  echo "Tmux sessions (detailed)"
  echo -e "${GRAY}$(date)${NC}"
  echo ""

  local session_count=0

  while IFS='|' read -r session_name session_created session_attached session_windows; do
    [[ -z "$session_name" ]] && continue

    ((session_count++))

    local status_indicator="○"
    if [[ "$session_attached" == "1" ]]; then
      status_indicator="●"
    elif [[ "$session_attached" -gt "1" ]]; then
      status_indicator="$session_attached"
    fi

    # Determine background color (alternate sessions)
    local bg_color=""
    if [[ $((session_count % 2)) -eq 1 ]]; then
      bg_color="$BG_SUBTLE"
    fi

    # Show windows for this session
    local first_window=true

    while IFS='|' read -r win_session win_index win_name win_panes win_active; do
      [[ "$win_session" != "$session_name" ]] && continue

      local window_indicator=" "
      if [[ "$win_active" == "1" ]]; then
        window_indicator="•"
      fi

      # Show panes for this window
      local first_pane=true
      while IFS='|' read -r pane_session pane_window pane_index pane_command pane_path pane_active; do
        [[ "$pane_session" != "$session_name" ]] && continue
        [[ "$pane_window" != "$win_index" ]] && continue

        if [[ "$first_window" = true && "$first_pane" = true ]]; then
          first_window=false
          first_pane=false
          echo -e "${bg_color}${status_indicator} $(printf "%-11s" "$session_name") ${window_indicator} $(printf "%-11s" "$win_name") $(printf "%-12s" "$pane_command") ${pane_path}${NC}"
        elif [[ "$first_pane" = true ]]; then
          first_pane=false
          echo -e "${bg_color}$(printf "%-13s" "") ${window_indicator} $(printf "%-11s" "$win_name") $(printf "%-12s" "$pane_command") ${pane_path}${NC}"
        else
          echo -e "${bg_color}$(printf "%-13s" "") $(printf "%-13s" "") $(printf "%-12s" "$pane_command") ${pane_path}${NC}"
        fi
      done <<< "$panes_data"

    done <<< "$windows_data"
  done <<< "$sessions_data"
}

# Main function
main() {
  if [[ "$SHOW_HELP" = true ]]; then
    show_help
    exit 0
  fi

  check_tmux

  if [[ "$JSON_OUTPUT" = true ]]; then
    output_json
  elif [[ "$DETAILED" = true ]]; then
    output_detailed
  else
    output_summary
  fi
}

main "$@"