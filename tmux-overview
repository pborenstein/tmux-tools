#!/bin/bash

# tmux-overview - Display comprehensive information about all tmux sessions
# Usage: tmux-overview [options]

set -euo pipefail

# Get the directory where this script is located (resolving symlinks)
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do
  SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$SCRIPT_DIR/$SOURCE"
done
SCRIPT_DIR="$(cd -P "$(dirname "$SOURCE")" && pwd)"

# Source shared libraries
source "$SCRIPT_DIR/lib/tmux_core.sh"
source "$SCRIPT_DIR/lib/tmux_display.sh"
source "$SCRIPT_DIR/lib/tmux_colors.sh"
source "$SCRIPT_DIR/lib/tmux_config.sh"

# Load configuration
load_config

# Default options
DETAILED=false
JSON_OUTPUT=false
SESSION_FILTER=""
SHOW_HELP=false
THEME_OVERRIDE=""

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    -d|--detailed)
      DETAILED=true
      shift
      ;;
    -j|--json)
      JSON_OUTPUT=true
      shift
      ;;
    -s|--session)
      SESSION_FILTER="$2"
      shift 2
      ;;
    -t|--theme)
      if [[ -z "$2" || "$2" == -* ]]; then
        echo "Error: --theme requires a theme name" >&2
        exit 1
      fi
      THEME_OVERRIDE="$2"
      shift 2
      ;;
    -h|--help)
      SHOW_HELP=true
      shift
      ;;
    *)
      echo "Unknown option: $1"
      exit 1
      ;;
  esac
done

# Help function
show_help() {
  cat << EOF
tmux-overview - Display comprehensive information about all tmux sessions

USAGE:
    tmux-overview [OPTIONS]

OPTIONS:
    -d, --detailed          Show detailed view with all panes and commands
    -j, --json             Output in JSON format
    -s, --session NAME     Show only the specified session
    -t, --theme THEME      Color theme (default, vibrant, subtle, monochrome, none)
    -h, --help             Show this help message

EXAMPLES:
    tmux-overview                    # Show summary of all sessions
    tmux-overview -d                 # Show detailed view with all panes
    tmux-overview -s milan           # Show only 'milan' session
    tmux-overview -j                 # Output in JSON format
    tmux-overview --theme vibrant    # Use vibrant color theme

EOF
}

# Initialize colors based on configuration or override
if [[ -n "$THEME_OVERRIDE" ]]; then
  init_colors "$THEME_OVERRIDE"
else
  init_colors "$(get_config_value "theme")"
fi

# Get session data with optional filtering
get_filtered_sessions() {
  local sessions_data
  sessions_data=$(get_session_data)

  if [[ -n "$SESSION_FILTER" ]]; then
    echo "$sessions_data" | grep "^$SESSION_FILTER|" || true
  else
    echo "$sessions_data"
  fi
}

# Get window data with optional filtering
get_filtered_windows() {
  local windows_data
  if [[ -n "$SESSION_FILTER" ]]; then
    windows_data=$(get_window_data "$SESSION_FILTER")
  else
    windows_data=$(get_window_data)
  fi

  if [[ -n "$SESSION_FILTER" ]]; then
    echo "$windows_data" | grep "^$SESSION_FILTER|" || true
  else
    echo "$windows_data"
  fi
}

# Get pane data with optional filtering
get_filtered_panes() {
  local panes_data
  panes_data=$(get_pane_data)

  if [[ -n "$SESSION_FILTER" ]]; then
    echo "$panes_data" | grep "^$SESSION_FILTER|" || true
  else
    echo "$panes_data"
  fi
}

# JSON output
output_json() {
  local sessions_data windows_data panes_data
  sessions_data=$(get_filtered_sessions)
  windows_data=$(get_filtered_windows)
  panes_data=$(get_filtered_panes)

  echo "{"
  echo '  "sessions": ['

  local first_session=true
  while IFS='|' read -r session_name session_created session_attached session_windows; do
    [[ -z "$session_name" ]] && continue

    if [[ "$first_session" = false ]]; then
      echo ","
    fi
    first_session=false

    echo "    {"
    echo "      \"name\": \"$session_name\","
    echo "      \"created\": \"$(format_timestamp "$session_created")\","
    echo "      \"attached\": $session_attached,"
    echo "      \"windows\": ["

    local first_window=true
    while IFS='|' read -r win_session win_index win_name win_panes win_active; do
      [[ "$win_session" != "$session_name" ]] && continue

      if [[ "$first_window" = false ]]; then
        echo ","
      fi
      first_window=false

      echo "        {"
      echo "          \"index\": $win_index,"
      echo "          \"name\": \"$win_name\","
      echo "          \"panes\": $win_panes,"
      echo "          \"active\": $win_active,"
      echo "          \"pane_details\": ["

      local first_pane=true
      while IFS='|' read -r pane_session pane_window pane_index pane_command pane_path pane_active; do
        [[ "$pane_session" != "$session_name" ]] && continue
        [[ "$pane_window" != "$win_index" ]] && continue

        if [[ "$first_pane" = false ]]; then
          echo ","
        fi
        first_pane=false

        echo "            {"
        echo "              \"index\": $pane_index,"
        echo "              \"command\": \"$pane_command\","
        echo "              \"path\": \"$pane_path\","
        echo "              \"active\": $pane_active"
        echo -n "            }"
      done <<< "$panes_data"

      echo ""
      echo "          ]"
      echo -n "        }"
    done <<< "$windows_data"

    echo ""
    echo "      ]"
    echo -n "    }"
  done <<< "$sessions_data"

  echo ""
  echo "  ]"
  echo "}"
}

# Summary output
output_summary() {
  local sessions_data windows_data
  sessions_data=$(get_filtered_sessions)
  windows_data=$(get_filtered_windows)

  local total_sessions=0
  local total_windows=0
  local session_count=0

  while IFS='|' read -r session_name session_created session_attached session_windows; do
    [[ -z "$session_name" ]] && continue

    ((total_sessions++))
    ((session_count++))
    ((total_windows += session_windows))

    local status_indicator
    status_indicator=$(get_session_indicator "$session_attached")

    # Determine background color (alternate sessions)
    local bg_color
    bg_color=$(get_background_color "$session_count" "$(get_color "background")")

    # Show windows for this session
    local first_window=true

    while IFS='|' read -r win_session win_index win_name win_panes win_active; do
      [[ "$win_session" != "$session_name" ]] && continue

      local window_indicator
      window_indicator=$(get_window_indicator "$win_active")

      local pane_display
      pane_display=$(format_pane_display "$win_panes")

      if [[ "$first_window" = true ]]; then
        first_window=false
        print_overview_row "$bg_color" "$status_indicator" "$session_name" "$window_indicator" "$win_name" "$pane_display" "$(get_color "reset")"
      else
        print_overview_row "$bg_color" "$status_indicator" "" "$window_indicator" "$win_name" "$pane_display" "$(get_color "reset")"
      fi
    done <<< "$windows_data"
  done <<< "$sessions_data"
}

# Detailed output
output_detailed() {
  local sessions_data windows_data panes_data
  sessions_data=$(get_filtered_sessions)
  windows_data=$(get_filtered_windows)
  panes_data=$(get_filtered_panes)

  echo "Tmux sessions (detailed)"
  echo -e "$(colorize "$(get_color "gray")" "$(date)")"
  echo ""

  local session_count=0

  while IFS='|' read -r session_name session_created session_attached session_windows; do
    [[ -z "$session_name" ]] && continue

    ((session_count++))

    local status_indicator
    status_indicator=$(get_session_indicator "$session_attached")

    # Determine background color (alternate sessions)
    local bg_color
    bg_color=$(get_background_color "$session_count" "$(get_color "background")")

    # Show windows for this session
    local first_window=true

    while IFS='|' read -r win_session win_index win_name win_panes win_active; do
      [[ "$win_session" != "$session_name" ]] && continue

      local window_indicator
      window_indicator=$(get_window_indicator "$win_active")

      # Show panes for this window
      local first_pane=true
      while IFS='|' read -r pane_session pane_window pane_index pane_command pane_path pane_active; do
        [[ "$pane_session" != "$session_name" ]] && continue
        [[ "$pane_window" != "$win_index" ]] && continue

        print_detailed_overview_row "$bg_color" "$status_indicator" "$session_name" "$window_indicator" "$win_name" "$pane_command" "$pane_path" "$first_window" "$first_pane" "$(get_color "reset")"

        if [[ "$first_window" = true ]]; then
          first_window=false
        fi
        if [[ "$first_pane" = true ]]; then
          first_pane=false
        fi
      done <<< "$panes_data"

    done <<< "$windows_data"
  done <<< "$sessions_data"
}

# Main function
main() {
  if [[ "$SHOW_HELP" = true ]]; then
    show_help
    exit 0
  fi

  if ! check_tmux_available; then
    exit 1
  fi

  if ! check_tmux_running; then
    exit 0
  fi

  if [[ "$JSON_OUTPUT" = true ]]; then
    output_json
  elif [[ "$DETAILED" = true ]]; then
    output_detailed
  else
    output_summary
  fi
}

main "$@"